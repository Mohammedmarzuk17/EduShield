name: Update EduShield Blocklists

on:
  schedule:
    - cron: '0 1 * * *'  # Runs daily at 01:00 UTC
  workflow_dispatch:     # Manual trigger option

jobs:
  update-blocklists:
    runs-on: ubuntu-latest
    steps:
      # 1️⃣ Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          persist-credentials: false  # prevent default token usage

      # 2️⃣ Set up Python
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.13

      # 3️⃣ Install dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4 pandas PyPDF2

      # 4️⃣ Run the blocklist update script
      - name: Run blocklist update script
        run: python update_blocklist.py

      # 5️⃣ Split blocklist into multiple files by source
      - name: Split blocklist by source
        run: |
          mkdir -p blocklists

          python - <<'EOF'
          import json, os

          with open("blocklist.json", "r", encoding="utf-8") as f:
              data = json.load(f)

          domains = data.get("domains", [])
          grouped = {}

          for entry in domains:
              if isinstance(entry, dict):
                  src = entry.get("source", "unknown")
                  grouped.setdefault(src, []).append(entry)
              else:
                  grouped.setdefault("unknown", []).append({"domain": str(entry), "source": "unknown"})

          os.makedirs("blocklists", exist_ok=True)
          for src, items in grouped.items():
              out_file = f"blocklists/{src.lower().replace(' ', '_')}.json"
              with open(out_file, "w", encoding="utf-8") as f:
                  json.dump({"domains": items}, f, indent=2, ensure_ascii=False)
              print(f"✅ Saved {len(items)} entries to {out_file}")
          EOF

      # 6️⃣ Generate manifest.json listing all blocklists
      - name: Generate blocklists/manifest.json
        run: |
          mkdir -p blocklists
          FILES=$(ls blocklists/*.json | xargs -n1 basename | jq -R -s -c 'split("\n")[:-1]')
          echo "{\"files\": $FILES}" > blocklists/manifest.json
          cat blocklists/manifest.json

      # 7️⃣ Commit and push updates
      - name: Commit and push updated blocklists
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git remote set-url origin "https://${PAT_TOKEN}@github.com/${{ github.repository }}.git"

          git add blocklist.json blocklists/*.json
          git commit -m "Auto-update blocklists (split by source + manifest)" || echo "No changes to commit"

          git pull origin main --rebase || echo "No remote changes to pull"
          git push origin HEAD:main --force
        env:
          PAT_TOKEN: ${{ secrets.edushield_token }}
